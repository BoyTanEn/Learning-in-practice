### 副本基本信息

- **Replica** ：副本，同一分区的不同副本保存的是相同的消息，为保证集群中的某个节点发生故障时，该节点上的 partition <font color = 'red'>数据不丢失 ，提高副本可靠性</font>，且 kafka 仍然能够继续工作，kafka 提供了副本机制，一个 topic 的每个分区都有若干个副本，一个 leader 和若干个 follower。

- **Leader** ：每个分区的多个副本中的"主副本"，**生产者以及消费者只与 Leader 交互。**(和MySQL的主从不一样，Kafka的Leader负责写和读，从只负责备份)

- **Follower** ：每个分区的多个副本中的"从副本"，负责实时从 Leader 中同步数据，保持和 Leader 数据的同步。Leader 发生故障时，从 Follower 副本中重新选举新的 Leader 副本对外提供服务。

![](images/7.Kafka副本机制.png)

- AR:分区中的所有 Replica 统称为 AR = ISR +OSR
- ISR:所有与 Leader 副本保持一定程度同步的Replica(包括 Leader 副本在内)组成 ISR
- OSR:与 Leader 副本同步滞后过多的 Replica 组成了 OSR
- LEO:每个副本都有内部的LEO，代表当前队列消息的最后一条偏移量offset + 1。
- HW:高水位，代表所有ISR中的LEO最低的那个offset，也是消费者可见的最大消息offset。

### 副本选举Leader

Kafka 集群中有一个 broker 的 Controller 会被选举为 <font color = 'red'>Controller Leader (4.2.2) </font>，负责管理集群Broker 的上下线，所有 topic 的<font color = 'red'>分区副本分配</font>和 <font color = 'red'>Leader 选举等</font>工作。

Broker中Controller 的信息同步工作是依赖于 Zookeeper 的 ./broker/topic 目录下的信息。

![](images/8.zk与Kafka选举.png)

<font color = 'red'>结论先行： 如果leader副本下线， 会在ISR队列中存活为前提，按照**Replicas队列中前面优先**的原则。</font>

（1）创建一个新的 topic，4 个分区，4 个副本

```shell
kafka-topics.sh --bootstrap-server ip:9092 --create --topic luojia1 --partitions 4 --replication-factor 4
```

（2）查看 Leader 分布情况

```xml
kafka-topics.sh --bootstrap-server ip:9092 --describe --topic luojia1

Topic: luojia1 TopicId: awpgX_7WR-OX3Vl6HE8sVg PartitionCount: 4 ReplicationFactor: 4
Configs: segment.bytes=1073741824
Topic: luojia1 Partition: 0 Leader: 3 Replicas: 3,0,2,1 Isr: 3,0,2,1
Topic: luojia1 Partition: 1 Leader: 1 Replicas: 1,2,3,0 Isr: 1,2,3,0
Topic: luojia1 Partition: 2 Leader: 0 Replicas: 0,3,1,2 Isr: 0,3,1,2
Topic: luojia1 Partition: 3 Leader: 2 Replicas: 2,1,0,3 Isr: 2,1,0,3
```

（3）停止掉 hadoop105(brokerId 为3) 的 kafka 进程，并查看 Leader 分区情况

> 预计结果：Partition: 0的主机将会重选新Leader，根据 Isr 的在线情况，选择Replicas 中，排在最前面的主机节点，即会选择0（3,0,2,1 3下线，0还在线）

```shell
kafka-server-stop.sh
```

```shell
kafka-topics.sh --bootstrap-server ip:9092 --describe --topic luojia1

Topic: luojia1 TopicId: awpgX_7WR-OX3Vl6HE8sVg PartitionCount: 4 ReplicationFactor: 4
Configs: segment.bytes=1073741824
Topic: luojia1 Partition: 0 Leader: 0 Replicas: 3,0,2,1 Isr: 0,2,1
Topic: luojia1 Partition: 1 Leader: 1 Replicas: 1,2,3,0 Isr: 1,2,0
Topic: luojia1 Partition: 2 Leader: 0 Replicas: 0,3,1,2 Isr: 0,1,2
Topic: luojia1 Partition: 3 Leader: 2 Replicas: 2,1,0,3 Isr: 2,1,0

```

（4）停止掉 hadoop104(brokerId 为2) 的 kafka 进程，并查看 Leader 分区情况

```shell
kafka-server-stop.sh
kafka-topics.sh --bootstrap-server ip:9092 --describe  --topic luojia1

Topic: luojia1 TopicId: awpgX_7WR-OX3Vl6HE8sVg PartitionCount: 4 ReplicationFactor: 4
Configs: segment.bytes=1073741824
Topic: luojia1 Partition: 0 Leader: 0 Replicas: 3,0,2,1 Isr: 0,1
Topic: luojia1 Partition: 1 Leader: 1 Replicas: 1,2,3,0 Isr: 1,0
Topic: luojia1 Partition: 2 Leader: 0 Replicas: 0,3,1,2 Isr: 0,1
Topic: luojia1 Partition: 3 Leader: 1 Replicas: 2,1,0,3 Isr: 1,0

```

（5）如果此时 hadoop105(brokerId 为3) 恢复，再次查看Leader分区情况

```shell
kafka-server-stop.sh
kafka-topics.sh --bootstrap-server ip:9092 --describe  --topic luojia1

Topic: luojia1 TopicId: awpgX_7WR-OX3Vl6HE8sVg PartitionCount: 4 ReplicationFactor: 4
Configs: segment.bytes=1073741824
Topic: luojia1 Partition: 0 Leader: 0 Replicas: 3,0,2,1 Isr: 0,1,3
Topic: luojia1 Partition: 1 Leader: 1 Replicas: 1,2,3,0 Isr: 1,0,3
Topic: luojia1 Partition: 2 Leader: 0 Replicas: 0,3,1,2 Isr: 0,1,3
Topic: luojia1 Partition: 3 Leader: 1 Replicas: 2,1,0,3 Isr: 1,0,3
```

（6）停止掉 hadoop102(brokerId 为0) 的 kafka 进程，并查看 Leader 分区情况

```shell
kafka-server-stop.sh
kafka-topics.sh --bootstrap-server ip:9092 --describe  --topic luojia1

Topic: luojia1 TopicId: awpgX_7WR-OX3Vl6HE8sVg PartitionCount: 4 ReplicationFactor: 4
Configs: segment.bytes=1073741824
Topic: luojia1 Partition: 0 Leader: 3 Replicas: 3,0,2,1 Isr: 0,1,3
Topic: luojia1 Partition: 1 Leader: 1 Replicas: 1,2,3,0 Isr: 1,0,3
Topic: luojia1 Partition: 2 Leader: 3 Replicas: 0,3,1,2 Isr: 0,1,3
Topic: luojia1 Partition: 3 Leader: 1 Replicas: 2,1,0,3 Isr: 1,0,3
```















